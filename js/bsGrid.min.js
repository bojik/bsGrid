/*!
 * ===================================================
 * bsGrid.js v1.0.0
 * https://github.com/bojik/bsGrid
 * ===================================================
 *
 * Copyright 2012 Alexander Rodionov
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 * http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
(function(b){b.fn.bsGrid=function(c){this.each(function(){new a(b(this),c).initTable()});return this};function a(d,c){this.url=c.url||d.attr("data-url");this.limit=c.limit||d.attr("data-limit")||10;this.currentPage=c.currentPage||d.attr("data-current-page")||1;this.pager=c.pagination||d.attr("data-pagination");this.sortName=c.sortField||d.attr("data-sort-field");this.sortOrder=c.sortOrder||d.attr("data-sort-order")||"asc";this.sortIcon=c.sortIcon||d.attr("data-sort-icon")||"&uarr;&darr;";this.sortIconDesc=c.sortIconDesc||d.attr("data-sort-icon-desc")||"&darr;";this.sortIconAsc=c.sortIconAsc||d.attr("data-sort-icon-asc")||"&uarr;";this.nextPageIcon=c.nextPageIcon||d.attr("data-next-page-icon")||"&rarr;";this.prevPageIcon=c.prevPageIcon||d.attr("data-prev-page-icon")||"&larr;";this.formFilter=c.formFilter||d.attr("data-form-filter");this.displayingPages=c.displayingPages||d.attr("data-displaying-pages")||9;this.formatTd=c.formatTd||false;this.beforeLoading=c.beforeLoading||function(){};this.afterLoading=c.afterLoading||function(){};this.onLoading=c.onLoading||function(){};this.onClick=c.onClick||function(){};this.$table=d;this.$table.data("object",this);this.total=0;this.initTable=function(){var e=this,f=this.$table,g=f.find("thead").find("th");g.each(function(){var i=b(this);if(i.attr("data-sortname")){var h='<a href="" class="sort-column">'+i.text()+' <span class="dir">'+e.sortIcon+"</span></a>";i.html(h)}});g.find(".sort-column").click(function(){var i=e.sortName,h=e.sortOrder,j=b(this).parent();if(i==j.attr("data-sortname")){h=h=="asc"?"desc":"asc"}else{h="asc";i=j.attr("data-sortname")}e.sortName=i;e.sortOrder=h;e.currentPage=1;e.updateSorting();return false});this.updateSorting();this.bindEvents();this.bindGlobalEvents()};this.bindGlobalEvents=function(){var e=this.$table;e.bind("reload",function(){var f=b(this).data("object");f.currentPage=1;f.reloadData()})};this.bindEvents=function(){var f=this.pager,g=this;if(f){b(f).find("a").live("click",function(){var h=b(this);if(!h.attr("data-page")){return true}g.currentPage=h.attr("data-page");g.reloadData();return false})}var e=this.formFilter;if(e){b(e).submit(function(){g.currentPage=1;g.reloadData();return false})}};this.updateSorting=function(){var g=this.sortName,f=this.sortOrder,h=this.$table,e=this;h.find("thead").find("th").each(function(){var i=e.sortIcon,j=b(this);if(j.attr("data-sortname")==g){if(f=="asc"){i=e.sortIconAsc}else{i=e.sortIconDesc}}j.find(".dir").html(i)});this.reloadData()};this.reloadData=function(){var h=this.$table,e=h.find("tbody"),g=this;if(this.url){g.beforeLoading();var f=g.getPostData();b.post(g.url,f,function(m){g.onLoading(m);if(m.success){var l=m.rows,k=[];e.html("");for(var j=0;j<l.length;j++){var n=l[j];k=[];h.find("thead").find("th").each(function(){var i=b(this).attr("data-field");k.push(g.formatTableTd(n,i))});b("<tr>"+k.join("")+"</tr>").data("row",n).bind("click",function(){g.onClick(b(this).data("row"),this)}).appendTo(e)}g.total=m.total;if(m.currentPage){g.currentPage=m.currentPage}g.updatePages()}},"json").complete(function(){g.afterLoading()})}};this.formatTableTd=function(g,f){var e;if(this.formatTd&&b.isFunction(this.formatTd)){e=this.formatTd(g,f)}else{e="<td>"+g[f]+"</td>"}return e};this.getPostData=function(){var f={offset:(this.currentPage-1)*this.limit,sortName:this.sortName,sortOrder:this.sortOrder,limit:this.limit},e=this.formFilter,h=[];for(var g in f){h.push(g+"="+f[g])}var i=h.join("&");if(e){var j=b(e);i+="&"+j.serialize()}return i};this.updatePages=function(){var f=this.pager;if(!f){return false}var t=b(f),m=Math.ceil(parseFloat(this.total)/parseFloat(this.limit));if(m<=1){t.html("");return false}var j=[],l=parseInt(this.currentPage),k=l-1>0?l-1:l,q=l+1<=m?l+1:l,n=[],r=parseInt(this.displayingPages),h=0;if(r<m){var p=Math.floor(r/3),s=Math.floor(p/2);for(h=1;h<=p;h++){n.push(h)}var e=l-s,g=l+s;if(h-1>=e){e=h;g=e+p-1}g=g>m?m:g;for(h=e;h<=g;h++){n.push(h)}e=m-p+1;g=m;if(h-1>=e){e=h}for(h=e;h<=g;h++){n.push(h)}for(h=m;h>=1;h--){if(n.length>=r){break}if(b.inArray(h,n)==-1){n.push(h)}}n.sort(function(u,i){if(u==i){return 0}return u>i?1:-1})}else{for(h=1;h<=m;h++){n.push(h)}}j.push('<li class="'+(l==k?"disabled":"")+'"><a href="#page-'+k+'" data-page="'+k+'">'+this.prevPageIcon+"</a></li>");var o=0;for(h=0;h<n.length;h++){if(o+1!=n[h]){j.push('<li class="disabled"><a href="#">...</a></li>')}o=n[h];j.push('<li class="'+(o==l?"active":"")+'"><a href="#page-'+o+'" class="" data-page="'+o+'">'+o+"</a></li>")}j.push('<li class="'+(l==q?"disabled":"")+'"><a href="#page-'+q+'" data-page="'+q+'">'+this.nextPageIcon+"</a></li>");t.html("<ul>"+j.join("")+"</ul>");return true}}})(jQuery);